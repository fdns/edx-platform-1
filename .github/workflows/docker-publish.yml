name: Push Docker Images

on: [push]
jobs:
  # Push image to GitHub Packages.
  # See also https://docs.docker.com/docker-hub/builds/
  push:
    runs-on: ubuntu-16.04
    if: github.event_name == 'push'

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set up Python 3.5
        uses: actions/setup-python@v2
        with:
          python-version: 3.5

      - name: Install dependencies
        run: |
          #cat requirements/system/ubuntu/apt-repos.txt | xargs -i sudo add-apt-repository {}
          sudo apt-get update
          sudo apt-get install $(cat requirements/system/ubuntu/apt-packages.txt | tr '\n' ' ')
          npm install
          pip install setuptools
          pip install --exists-action w -r requirements/edx/testing.txt
          pip install coveralls==1.0
          pip freeze

      - name: Start mongodb
        run: docker run -d -p 27017:27017 mongodb:3.6

      - name: Run tests
        run: paver test_system -s cms --cov-args="-p"

      - name: Build and Push docker image
        env:
          DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run : make docker_build

      - name: Run tests
        run: docker run -e NO_PREREQ_INSTALL='true'--rm openedx/edx-platform:latest paver test_lib --cov-args="-p"
